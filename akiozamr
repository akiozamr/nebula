-- NEBULA CLIENT Anti-Lag Optimizer (Fixed & Enhanced)
-- Advanced optimization with proper FPS boost and no fog/bright sky

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NEBULA_HUB"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- Main frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0.35,0,0.35,0)
mainFrame.Position = UDim2.new(0.325,0,0.325,0)
mainFrame.BackgroundColor3 = Color3.fromRGB(28,28,38)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0,8)
mainCorner.Parent = mainFrame

-- Title bar
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1,0,0,30)
titleBar.BackgroundColor3 = Color3.fromRGB(18,18,28)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0,8)
titleCorner.Parent = titleBar

local titleText = Instance.new("TextLabel")
titleText.Size = UDim2.new(1,-80,1,0)
titleText.Position = UDim2.new(0,10,0,0)
titleText.BackgroundTransparency = 1
titleText.Text = "ðŸ’« NEBULA HUB (BETA)"
titleText.TextColor3 = Color3.fromRGB(100,200,255)
titleText.TextSize = 14
titleText.Font = Enum.Font.GothamBold
titleText.TextXAlignment = Enum.TextXAlignment.Left
titleText.Parent = titleBar

-- Close & Minimize buttons
local function createTitleButton(symbol,posX,color)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0,25,0,25)
    btn.Position = UDim2.new(1,posX,0,2.5)
    btn.BackgroundColor3 = color
    btn.BorderSizePixel = 0
    btn.Text = symbol
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.TextSize = 16
    btn.Font = Enum.Font.GothamBold
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0,4)
    corner.Parent = btn
    btn.Parent = titleBar
    return btn
end

local minimizeBtn = createTitleButton("âˆ’",-55,Color3.fromRGB(255,200,50))
local closeBtn = createTitleButton("Ã—",-25,Color3.fromRGB(255,80,80))

-- Content frame
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2.new(1,-20,1,-40)
contentFrame.Position = UDim2.new(0,10,0,35)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = mainFrame

-- FPS & Status
local fpsLabel = Instance.new("TextLabel")
fpsLabel.Size = UDim2.new(1,0,0,20)
fpsLabel.Position = UDim2.new(0,0,0,0)
fpsLabel.BackgroundTransparency = 1
fpsLabel.Text = "FPS: --"
fpsLabel.TextColor3 = Color3.fromRGB(100,255,100)
fpsLabel.TextSize = 12
fpsLabel.Font = Enum.Font.GothamBold
fpsLabel.TextXAlignment = Enum.TextXAlignment.Left
fpsLabel.Parent = contentFrame

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1,0,0,20)
statusLabel.Position = UDim2.new(0,0,0,20)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Ready"
statusLabel.TextColor3 = Color3.fromRGB(180,180,180)
statusLabel.TextSize = 12
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = contentFrame

-- Fungsi tombol abu-abu transparan dengan outline
local function createButton(text,yScale)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.9,0,0,35)
    btn.Position = UDim2.new(0.05,0,0, yScale)
    btn.BackgroundColor3 = Color3.fromRGB(128,128,128)
    btn.BackgroundTransparency = 0.4
    btn.BorderColor3 = Color3.fromRGB(180,180,180)
    btn.BorderSizePixel = 2
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(230,230,230)
    btn.TextSize = 14
    btn.Font = Enum.Font.GothamBold
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0,5)
    corner.Parent = btn
    btn.Parent = contentFrame
    return btn
end

-- Tombol utama (satu baris per tombol)
local optimizeBtn = createButton("âš¡ OPTIMIZE", 50)
local ultraBtn = createButton("ULTRA", 95)
local resetBtn = createButton("RESET", 140)

-- Hover effect
local function addHover(button)
    local normal = button.BackgroundColor3
    button.MouseEnter:Connect(function()
        TweenService:Create(button,TweenInfo.new(0.2),{BackgroundTransparency=0.1}):Play()
    end)
    button.MouseLeave:Connect(function()
        TweenService:Create(button,TweenInfo.new(0.2),{BackgroundTransparency=0.4}):Play()
    end)
end
addHover(optimizeBtn)
addHover(ultraBtn)
addHover(resetBtn)
addHover(closeBtn)
addHover(minimizeBtn)

-- FPS counter
local fps = 0
local lastTime = tick()
local frameCount = 0
local fpsConnection
fpsConnection = RunService.Heartbeat:Connect(function()
    frameCount = frameCount +1
    local current = tick()
    if current - lastTime >= 0.5 then
        fps = frameCount/(current-lastTime)
        frameCount = 0
        lastTime = current
        fpsLabel.Text = string.format("FPS: %.0f",fps)
        if fps>=50 then fpsLabel.TextColor3 = Color3.fromRGB(100,255,100)
        elseif fps>=30 then fpsLabel.TextColor3 = Color3.fromRGB(255,255,100)
        else fpsLabel.TextColor3 = Color3.fromRGB(255,100,100) end
    end
end)

-- Variabel
local isOptimized = false
local isUltraMode = false
local originalSettings = {}
local optimizedParts = {}
local isMinimized = false

-- Fungsi tombol (gunakan fungsi lama)
optimizeBtn.MouseButton1Click:Connect(function()
    if not isOptimized then
        statusLabel.Text = "Optimizing..."
        statusLabel.TextColor3 = Color3.fromRGB(255,200,100)
        -- panggil fungsi optimizePerformance() asli
        optimizePerformance()
    end
end)

ultraBtn.MouseButton1Click:Connect(function()
    if not isUltraMode then
        statusLabel.Text = "Ultra Mode..."
        statusLabel.TextColor3 = Color3.fromRGB(255,150,50)
        ultraOptimize()
    end
end)

resetBtn.MouseButton1Click:Connect(function()
    statusLabel.Text = "Resetting..."
    statusLabel.TextColor3 = Color3.fromRGB(255,200,100)
    resetSettings()
end)

-- Minimize button
minimizeBtn.MouseButton1Click:Connect(function()
    if isMinimized then
        mainFrame:TweenSize(UDim2.new(0.35,0,0.35,0),"Out","Quart",0.3,true)
        contentFrame.Visible = true
        minimizeBtn.Text = "âˆ’"
        isMinimized = false
    else
        mainFrame:TweenSize(UDim2.new(0.35,0,0,30),"Out","Quart",0.3,true)
        contentFrame.Visible = false
        minimizeBtn.Text = "+"
        isMinimized = true
    end
end)

-- Close button
closeBtn.MouseButton1Click:Connect(function()
    if fpsConnection then fpsConnection:Disconnect() end
    resetSettings()
    wait(0.3)
    screenGui:Destroy()
end)

print("NEBULA CLIENT Optimizer GUI siap digunakan!")

-- Save original settings (More comprehensive)
local function saveOriginalSettings()
    originalSettings = {
        -- Workspace
        StreamingEnabled = Workspace.StreamingEnabled,
        
        -- Lighting (Complete backup)
        GlobalShadows = Lighting.GlobalShadows,
        FogEnd = Lighting.FogEnd,
        FogStart = Lighting.FogStart,
        FogColor = Lighting.FogColor,
        Brightness = Lighting.Brightness,
        Technology = Lighting.Technology,
        Ambient = Lighting.Ambient,
        ColorShift_Bottom = Lighting.ColorShift_Bottom,
        ColorShift_Top = Lighting.ColorShift_Top,
        OutdoorAmbient = Lighting.OutdoorAmbient,
        ShadowSoftness = Lighting.ShadowSoftness,
        ClockTime = Lighting.ClockTime,
    }
    
    -- Safe rendering settings access
    pcall(function()
        originalSettings.QualityLevel = settings().Rendering.QualityLevel
        originalSettings.MeshPartDetailLevel = settings().Rendering.MeshPartDetailLevel
        originalSettings.GraphicsMode = settings().Rendering.GraphicsMode
    end)
end

-- Enhanced optimization for better FPS
local function optimizePerformance()
    if isOptimized then return end
    
    statusLabel.Text = "Optimizing..."
    statusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
    
    saveOriginalSettings()
    
    -- Workspace optimizations
    Workspace.StreamingEnabled = true
    
    -- FIXED: Proper lighting optimizations for FPS boost
    Lighting.GlobalShadows = false -- Disable shadows for FPS
    Lighting.Technology = Enum.Technology.Compatibility -- Best performance
    Lighting.FogEnd = 1000000 -- Remove fog completely
    Lighting.FogStart = 1000000
    Lighting.FogColor = Color3.fromRGB(255, 255, 255)
    Lighting.Brightness = 3 -- Bright sky
    Lighting.Ambient = Color3.fromRGB(128, 128, 128) -- Bright ambient
    Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
    Lighting.ClockTime = 14 -- Noon time for brightness
    Lighting.ShadowSoftness = 0
    
    -- FIXED: Aggressive rendering optimizations
    pcall(function()
        settings().Rendering.QualityLevel = Enum.QualityLevel.Level01 -- Lowest for max FPS
        settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level01
        settings().Rendering.GraphicsMode = Enum.GraphicsMode.Direct3D9
    end)
    
    -- FIXED: More aggressive part optimization
    local partCount = 0
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") then
            partCount = partCount + 1
            
            -- Optimize all surfaces
            obj.TopSurface = Enum.SurfaceType.Smooth
            obj.BottomSurface = Enum.SurfaceType.Smooth
            obj.LeftSurface = Enum.SurfaceType.Smooth
            obj.RightSurface = Enum.SurfaceType.Smooth
            obj.FrontSurface = Enum.SurfaceType.Smooth
            obj.BackSurface = Enum.SurfaceType.Smooth
            
            -- Convert expensive materials to simple ones
            if obj.Material ~= Enum.Material.Plastic and 
               obj.Material ~= Enum.Material.SmoothPlastic then
                obj.Material = Enum.Material.SmoothPlastic
            end
            
            -- Disable casting shadows
            obj.CastShadow = false
            
            -- Optimize CanCollide for non-essential parts
            if obj.Name:lower():find("decoration") or 
               obj.Name:lower():find("detail") or
               obj.Transparency > 0.5 then
                obj.CanCollide = false
            end
            
            table.insert(optimizedParts, obj)
            
        elseif obj:IsA("Texture") or obj:IsA("Decal") then
            -- More aggressive texture optimization
            obj.StudsPerTileU = 1
            obj.StudsPerTileV = 1
            if obj.Transparency < 0.1 then
                obj.Transparency = 0.1
            end
            
        elseif obj:IsA("ParticleEmitter") then
            -- Disable all particle effects (including snow/fog effects)
            obj.Enabled = false
            
        elseif obj:IsA("Fire") or obj:IsA("Smoke") or obj:IsA("Sparkles") then
            obj.Enabled = false
            
        elseif obj:IsA("Atmosphere") then
            -- Remove atmospheric effects (haze, fog, etc)
            obj.Density = 0
            obj.Offset = 0
            obj.Color = Color3.fromRGB(255, 255, 255)
            obj.Decay = Color3.fromRGB(255, 255, 255)
            obj.Glare = 0
            obj.Haze = 0
            
        elseif obj:IsA("Clouds") then
            -- Remove cloud effects
            obj.Enabled = false
            obj.Density = 0
            
        elseif obj:IsA("BloomEffect") or obj:IsA("BlurEffect") or obj:IsA("ColorCorrectionEffect") then
            -- Remove post-processing effects that cause blur
            obj.Enabled = false
            
        elseif obj:IsA("PointLight") or obj:IsA("SpotLight") or obj:IsA("SurfaceLight") then
            obj.Brightness = obj.Brightness * 0.3
            obj.Range = math.min(obj.Range, 10)
        end
        
        -- Process in chunks to prevent lag spikes
        if partCount % 100 == 0 then
            wait()
        end
    end
    
    -- Enhanced memory optimization
    collectgarbage("collect")
    wait(0.1)
    collectgarbage("collect")
    
    isOptimized = true
    statusLabel.Text = "Optimized âœ“"
    statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    optimizeBtn.Text = "âœ“ OPTIMIZED"
    optimizeBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
end

-- Fungsi untuk bikin player lain jadi abu-abu polos
local function simplifyCharacter(plr, char)
    if plr == player then return end -- biar kamu sendiri normal
    if not char then return end

    for _, obj in pairs(char:GetDescendants()) do
        if obj:IsA("BasePart") then
            obj.Color = Color3.fromRGB(150, 150, 150)
            obj.Material = Enum.Material.SmoothPlastic
            obj.CastShadow = false
        elseif obj:IsA("Decal") or obj:IsA("Texture") then
            obj.Transparency = 1
        end
    end
end

-- Ultra performance mode for extreme FPS boost
local function ultraOptimize()
    if isUltraMode then return end
    
    statusLabel.Text = "Ultra Mode..."
    statusLabel.TextColor3 = Color3.fromRGB(255, 150, 50)
    
    if not isOptimized then
        optimizePerformance()
        wait(0.5)
    end
    
    -- Ultra lighting (Maximum performance)
    Lighting.GlobalShadows = false
    Lighting.Technology = Enum.Technology.Legacy -- Fastest rendering
    Lighting.FogEnd = 1000000 -- No fog at all
    Lighting.FogStart = 1000000
    Lighting.Brightness = 5 -- Very bright
    Lighting.Ambient = Color3.fromRGB(178, 178, 178)
    Lighting.OutdoorAmbient = Color3.fromRGB(178, 178, 178)
    Lighting.ColorShift_Bottom = Color3.fromRGB(255, 255, 255)
    Lighting.ColorShift_Top = Color3.fromRGB(255, 255, 255)
    
    -- Ultra rendering settings
    pcall(function()
        settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
        settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level01
        settings().Rendering.GraphicsMode = Enum.GraphicsMode.Direct3D9
        settings().Physics.AllowSleep = true
        settings().Physics.ThrottleAdjustTime = 0
    end)
    
    -- Ultra part optimization
    for _, obj in pairs(optimizedParts) do
        if obj and obj.Parent then
            -- Convert everything to basic plastic
            obj.Material = Enum.Material.Plastic
            obj.Reflectance = 0
            obj.CastShadow = false
            
            -- Remove all surface details
            if obj:FindFirstChild("SurfaceGui") then
                obj.SurfaceGui:Destroy()
            end
        end
    end
    
    -- Disable all effects and lighting
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("ParticleEmitter") or 
           obj:IsA("Fire") or 
           obj:IsA("Smoke") or 
           obj:IsA("Sparkles") or
           obj:IsA("PointLight") or 
           obj:IsA("SpotLight") or 
           obj:IsA("SurfaceLight") then
            obj.Enabled = false
        elseif obj:IsA("Atmosphere") then
            -- Completely remove atmospheric effects
            obj.Density = 0
            obj.Offset = 0
            obj.Glare = 0
            obj.Haze = 0
        elseif obj:IsA("Clouds") then
            obj.Enabled = false
            obj.Density = 0
        elseif obj:IsA("BloomEffect") or obj:IsA("BlurEffect") or obj:IsA("ColorCorrectionEffect") then
            obj.Enabled = false
        elseif obj:IsA("Sound") and obj.IsPlaying then
            obj.Volume = obj.Volume * 0.5
        end
    end
    
    -- Multiple garbage collections
    for i = 1, 3 do
        collectgarbage("collect")
        wait(0.1)
    end
    
    isUltraMode = true
    statusLabel.Text = "Ultra âœ“"
    statusLabel.TextColor3 = Color3.fromRGB(255, 100, 50)
    ultraBtn.Text = "âœ“ ULTRA"
    ultraBtn.BackgroundColor3 = Color3.fromRGB(255, 150, 50)
end

-- Enhanced reset function
local function resetSettings()
    statusLabel.Text = "Resetting..."
    statusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
    
    -- Restore all settings
    if originalSettings.StreamingEnabled ~= nil then
        Workspace.StreamingEnabled = originalSettings.StreamingEnabled
    end
    
    -- Restore lighting completely
    Lighting.GlobalShadows = originalSettings.GlobalShadows or true
    Lighting.FogEnd = originalSettings.FogEnd or 100000
    Lighting.FogStart = originalSettings.FogStart or 0
    Lighting.FogColor = originalSettings.FogColor or Color3.fromRGB(191, 166, 143)
    Lighting.Brightness = originalSettings.Brightness or 1
    Lighting.Technology = originalSettings.Technology or Enum.Technology.ShadowMap
    Lighting.Ambient = originalSettings.Ambient or Color3.fromRGB(70, 70, 70)
    Lighting.ColorShift_Bottom = originalSettings.ColorShift_Bottom or Color3.fromRGB(0, 0, 0)
    Lighting.ColorShift_Top = originalSettings.ColorShift_Top or Color3.fromRGB(0, 0, 0)
    Lighting.OutdoorAmbient = originalSettings.OutdoorAmbient or Color3.fromRGB(70, 70, 70)
    Lighting.ShadowSoftness = originalSettings.ShadowSoftness or 0.2
    Lighting.ClockTime = originalSettings.ClockTime or 14
    
    -- Restore rendering settings
    pcall(function()
        if originalSettings.QualityLevel then
            settings().Rendering.QualityLevel = originalSettings.QualityLevel
        end
        if originalSettings.MeshPartDetailLevel then
            settings().Rendering.MeshPartDetailLevel = originalSettings.MeshPartDetailLevel
        end
        if originalSettings.GraphicsMode then
            settings().Rendering.GraphicsMode = originalSettings.GraphicsMode
        end
    end)
    
    -- Re-enable all effects
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("ParticleEmitter") or 
           obj:IsA("Fire") or 
           obj:IsA("Smoke") or 
           obj:IsA("Sparkles") or
           obj:IsA("PointLight") or 
           obj:IsA("SpotLight") or 
           obj:IsA("SurfaceLight") then
            obj.Enabled = true
        end
    end
    
    collectgarbage("collect")
    
    -- Reset variables
    isOptimized = false
    isUltraMode = false
    optimizedParts = {}
    
    statusLabel.Text = "Reset âœ“"
    statusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
    optimizeBtn.Text = "âš¡ OPTIMIZE"
    optimizeBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 250)
    ultraBtn.Text = "ULTRA"
    ultraBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 50)
end

-- Minimize function
local function toggleMinimize()
    if isMinimized then
        -- Restore window
        mainFrame:TweenSize(UDim2.new(0, 300, 0, 200), "Out", "Quart", 0.3, true)
        contentFrame.Visible = true
        minimizeBtn.Text = "âˆ’"
        isMinimized = false
    else
        -- Minimize window
        contentFrame.Visible = false
        mainFrame:TweenSize(UDim2.new(0, 300, 0, 25), "Out", "Quart", 0.3, true)
        minimizeBtn.Text = "+"
        isMinimized = true
    end
end

-- Button connections
optimizeBtn.MouseButton1Click:Connect(optimizePerformance)
ultraBtn.MouseButton1Click:Connect(ultraOptimize)
resetBtn.MouseButton1Click:Connect(resetSettings)
minimizeBtn.MouseButton1Click:Connect(toggleMinimize)

closeBtn.MouseButton1Click:Connect(function()
    if fpsConnection then
        fpsConnection:Disconnect()
    end
    if isOptimized or isUltraMode then
        resetSettings()
        wait(0.5)
    end
    screenGui:Destroy()
end)

-- Enhanced hover effects
local function addHoverEffect(button, normalColor, hoverColor)
    button.MouseEnter:Connect(function()
        local tween = TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = hoverColor})
        tween:Play()
    end)
    button.MouseLeave:Connect(function()
        local tween = TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = normalColor})
        tween:Play()
    end)
end

addHoverEffect(optimizeBtn, Color3.fromRGB(50, 150, 250), Color3.fromRGB(70, 170, 255))
addHoverEffect(resetBtn, Color3.fromRGB(150, 50, 50), Color3.fromRGB(170, 70, 70))
addHoverEffect(ultraBtn, Color3.fromRGB(255, 100, 50), Color3.fromRGB(255, 120, 70))
addHoverEffect(closeBtn, Color3.fromRGB(255, 80, 80), Color3.fromRGB(255, 100, 100))
addHoverEffect(minimizeBtn, Color3.fromRGB(255, 200, 50), Color3.fromRGB(255, 220, 70))

-- Auto-optimization detector
spawn(function()
    wait(5)
    while screenGui.Parent do
        if fps < 20 and not isOptimized then
            statusLabel.Text = "Low FPS detected"
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
        wait(10)
    end
end)

print("NEBULA CLIENT Optimizer (BETA) loaded! (Fixed Version)")
print("Changes: Better FPS optimization, No fog, Bright sky, Enhanced rendering")