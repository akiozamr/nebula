-- NEBULA CLIENT Anti-Lag Optimizer (Fixed & Enhanced)
-- Advanced optimization with proper FPS boost and no fog/bright sky

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- VARIABLES
local isOptimized = false
local isUltraMode = false
local fps = 0
local lastTime = tick()
local frameCount = 0
local isMinimized = false

-- Function: Hover effect with smooth tween
local function addHoverEffect(button, normalColor, hoverColor)
    button.MouseEnter:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundColor3 = hoverColor}):Play()
    end)
    button.MouseLeave:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundColor3 = normalColor}):Play()
    end)
end

-- MAIN GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NEBULA_HUB"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- Main frame (transparan abu-abu)
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 380, 0, 260)
mainFrame.Position = UDim2.new(0.5, -190, 0.5, -130)
mainFrame.BackgroundColor3 = Color3.fromRGB(60,60,60)
mainFrame.BackgroundTransparency = 0.2
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0,14)
mainCorner.Parent = mainFrame

local mainStroke = Instance.new("UIStroke")
mainStroke.Color = Color3.fromRGB(120,120,120)
mainStroke.Thickness = 1
mainStroke.Parent = mainFrame

-- Title bar
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1,0,0,32)
titleBar.BackgroundColor3 = Color3.fromRGB(50,50,50)
titleBar.BackgroundTransparency = 0.2
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0,14)
titleCorner.Parent = titleBar

local titleStroke = Instance.new("UIStroke")
titleStroke.Color = Color3.fromRGB(120,120,120)
titleStroke.Thickness = 1
titleStroke.Parent = titleBar

local titleText = Instance.new("TextLabel")
titleText.Size = UDim2.new(1,-60,1,0)
titleText.Position = UDim2.new(0,15,0,0)
titleText.BackgroundTransparency = 1
titleText.Text = "ðŸ’« NEBULA HUB"
titleText.TextColor3 = Color3.fromRGB(200,200,200)
titleText.TextSize = 16
titleText.Font = Enum.Font.GothamBold
titleText.TextXAlignment = Enum.TextXAlignment.Left
titleText.Parent = titleBar

-- Close button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0,26,0,26)
closeBtn.Position = UDim2.new(1,-32,0,3)
closeBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
closeBtn.Text = "Ã—"
closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
closeBtn.TextSize = 16
closeBtn.Font = Enum.Font.GothamBold
closeBtn.BorderSizePixel = 0
closeBtn.Parent = titleBar

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0,6)
closeCorner.Parent = closeBtn

local closeStroke = Instance.new("UIStroke")
closeStroke.Color = Color3.fromRGB(150,150,150)
closeStroke.Thickness = 1
closeStroke.Parent = closeBtn

addHoverEffect(closeBtn, Color3.fromRGB(100,100,100), Color3.fromRGB(150,150,150))

-- Minimize button
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.new(0,26,0,26)
minimizeBtn.Position = UDim2.new(1,-64,0,3)
minimizeBtn.BackgroundColor3 = Color3.fromRGB(100,100,100)
minimizeBtn.Text = "âˆ’"
minimizeBtn.TextColor3 = Color3.fromRGB(255,255,255)
minimizeBtn.TextSize = 16
minimizeBtn.Font = Enum.Font.GothamBold
minimizeBtn.BorderSizePixel = 0
minimizeBtn.Parent = titleBar

local minimizeCorner = Instance.new("UICorner")
minimizeCorner.CornerRadius = UDim.new(0,6)
minimizeCorner.Parent = minimizeBtn

local minimizeStroke = Instance.new("UIStroke")
minimizeStroke.Color = Color3.fromRGB(150,150,150)
minimizeStroke.Thickness = 1
minimizeStroke.Parent = minimizeBtn

addHoverEffect(minimizeBtn, Color3.fromRGB(100,100,100), Color3.fromRGB(150,150,150))

-- Content frame
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2.new(1,-20,1,-42)
contentFrame.Position = UDim2.new(0,10,0,34)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = mainFrame

local layout = Instance.new("UIListLayout")
layout.Padding = UDim.new(0,10)
layout.FillDirection = Enum.FillDirection.Vertical
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Parent = contentFrame

-- FPS label
local fpsLabel = Instance.new("TextLabel")
fpsLabel.Size = UDim2.new(1,0,0,20)
fpsLabel.BackgroundTransparency = 1
fpsLabel.Text = "FPS: --"
fpsLabel.TextColor3 = Color3.fromRGB(180,180,180)
fpsLabel.TextSize = 13
fpsLabel.Font = Enum.Font.GothamBold
fpsLabel.TextXAlignment = Enum.TextXAlignment.Left
fpsLabel.Parent = contentFrame

-- Status label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1,0,0,20)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Ready"
statusLabel.TextColor3 = Color3.fromRGB(180,180,180)
statusLabel.TextSize = 12
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = contentFrame

-- Function to create buttons (abu-abu + outline)
local function createButton(text)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.92,0,0,38)
    btn.BackgroundColor3 = Color3.fromRGB(100,100,100)
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.TextSize = 14
    btn.Font = Enum.Font.GothamBold
    btn.BorderSizePixel = 0

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0,10)
    corner.Parent = btn

    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(150,150,150)
    stroke.Thickness = 1
    stroke.Parent = btn

    addHoverEffect(btn, Color3.fromRGB(100,100,100), Color3.fromRGB(140,140,140))

    btn.Parent = contentFrame
    return btn
end

local optimizeBtn = createButton("âš¡ OPTIMIZE")
local resetBtn = createButton("RESET")
local ultraBtn = createButton("ULTRA")

-- FPS updater
RunService.Heartbeat:Connect(function()
    frameCount = frameCount + 1
    local currentTime = tick()
    if currentTime - lastTime >= 0.5 then
        fps = frameCount/(currentTime-lastTime)
        frameCount = 0
        lastTime = currentTime
        fpsLabel.Text = string.format("FPS: %.0f", fps)
        if fps >= 50 then
            fpsLabel.TextColor3 = Color3.fromRGB(100,255,180)
        elseif fps >= 30 then
            fpsLabel.TextColor3 = Color3.fromRGB(255,255,100)
        else
            fpsLabel.TextColor3 = Color3.fromRGB(255,100,100)
        end
    end
end)

-- Save original settings (More comprehensive)
local function saveOriginalSettings()
    originalSettings = {
        -- Workspace
        StreamingEnabled = Workspace.StreamingEnabled,
        
        -- Lighting (Complete backup)
        GlobalShadows = Lighting.GlobalShadows,
        FogEnd = Lighting.FogEnd,
        FogStart = Lighting.FogStart,
        FogColor = Lighting.FogColor,
        Brightness = Lighting.Brightness,
        Technology = Lighting.Technology,
        Ambient = Lighting.Ambient,
        ColorShift_Bottom = Lighting.ColorShift_Bottom,
        ColorShift_Top = Lighting.ColorShift_Top,
        OutdoorAmbient = Lighting.OutdoorAmbient,
        ShadowSoftness = Lighting.ShadowSoftness,
        ClockTime = Lighting.ClockTime,
    }
    
    -- Safe rendering settings access
    pcall(function()
        originalSettings.QualityLevel = settings().Rendering.QualityLevel
        originalSettings.MeshPartDetailLevel = settings().Rendering.MeshPartDetailLevel
        originalSettings.GraphicsMode = settings().Rendering.GraphicsMode
    end)
end

-- Enhanced optimization for better FPS
local function optimizePerformance()
    if isOptimized then return end
    
    statusLabel.Text = "Optimizing..."
    statusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
    
    saveOriginalSettings()
    
    -- Workspace optimizations
    Workspace.StreamingEnabled = true
    
    -- FIXED: Proper lighting optimizations for FPS boost
    Lighting.GlobalShadows = false -- Disable shadows for FPS
    Lighting.Technology = Enum.Technology.Compatibility -- Best performance
    Lighting.FogEnd = 1000000 -- Remove fog completely
    Lighting.FogStart = 1000000
    Lighting.FogColor = Color3.fromRGB(255, 255, 255)
    Lighting.Brightness = 3 -- Bright sky
    Lighting.Ambient = Color3.fromRGB(128, 128, 128) -- Bright ambient
    Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
    Lighting.ClockTime = 14 -- Noon time for brightness
    Lighting.ShadowSoftness = 0
    
    -- FIXED: Aggressive rendering optimizations
    pcall(function()
        settings().Rendering.QualityLevel = Enum.QualityLevel.Level01 -- Lowest for max FPS
        settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level01
        settings().Rendering.GraphicsMode = Enum.GraphicsMode.Direct3D9
    end)
    
    -- FIXED: More aggressive part optimization
    local partCount = 0
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") then
            partCount = partCount + 1
            
            -- Optimize all surfaces
            obj.TopSurface = Enum.SurfaceType.Smooth
            obj.BottomSurface = Enum.SurfaceType.Smooth
            obj.LeftSurface = Enum.SurfaceType.Smooth
            obj.RightSurface = Enum.SurfaceType.Smooth
            obj.FrontSurface = Enum.SurfaceType.Smooth
            obj.BackSurface = Enum.SurfaceType.Smooth
            
            -- Convert expensive materials to simple ones
            if obj.Material ~= Enum.Material.Plastic and 
               obj.Material ~= Enum.Material.SmoothPlastic then
                obj.Material = Enum.Material.SmoothPlastic
            end
            
            -- Disable casting shadows
            obj.CastShadow = false
            
            -- Optimize CanCollide for non-essential parts
            if obj.Name:lower():find("decoration") or 
               obj.Name:lower():find("detail") or
               obj.Transparency > 0.5 then
                obj.CanCollide = false
            end
            
            table.insert(optimizedParts, obj)
            
        elseif obj:IsA("Texture") or obj:IsA("Decal") then
            -- More aggressive texture optimization
            obj.StudsPerTileU = 1
            obj.StudsPerTileV = 1
            if obj.Transparency < 0.1 then
                obj.Transparency = 0.1
            end
            
        elseif obj:IsA("ParticleEmitter") then
            -- Disable all particle effects (including snow/fog effects)
            obj.Enabled = false
            
        elseif obj:IsA("Fire") or obj:IsA("Smoke") or obj:IsA("Sparkles") then
            obj.Enabled = false
            
        elseif obj:IsA("Atmosphere") then
            -- Remove atmospheric effects (haze, fog, etc)
            obj.Density = 0
            obj.Offset = 0
            obj.Color = Color3.fromRGB(255, 255, 255)
            obj.Decay = Color3.fromRGB(255, 255, 255)
            obj.Glare = 0
            obj.Haze = 0
            
        elseif obj:IsA("Clouds") then
            -- Remove cloud effects
            obj.Enabled = false
            obj.Density = 0
            
        elseif obj:IsA("BloomEffect") or obj:IsA("BlurEffect") or obj:IsA("ColorCorrectionEffect") then
            -- Remove post-processing effects that cause blur
            obj.Enabled = false
            
        elseif obj:IsA("PointLight") or obj:IsA("SpotLight") or obj:IsA("SurfaceLight") then
            obj.Brightness = obj.Brightness * 0.3
            obj.Range = math.min(obj.Range, 10)
        end
        
        -- Process in chunks to prevent lag spikes
        if partCount % 100 == 0 then
            wait()
        end
    end
    
    -- Enhanced memory optimization
    collectgarbage("collect")
    wait(0.1)
    collectgarbage("collect")
    
    isOptimized = true
    statusLabel.Text = "Optimized âœ“"
    statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    optimizeBtn.Text = "âœ“ OPTIMIZED"
    optimizeBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
end

-- Fungsi untuk bikin player lain jadi abu-abu polos
local function simplifyCharacter(plr, char)
    if plr == player then return end -- biar kamu sendiri normal
    if not char then return end

    for _, obj in pairs(char:GetDescendants()) do
        if obj:IsA("BasePart") then
            obj.Color = Color3.fromRGB(150, 150, 150)
            obj.Material = Enum.Material.SmoothPlastic
            obj.CastShadow = false
        elseif obj:IsA("Decal") or obj:IsA("Texture") then
            obj.Transparency = 1
        end
    end
end

-- Ultra performance mode for extreme FPS boost
local function ultraOptimize()
    if isUltraMode then return end
    
    statusLabel.Text = "Ultra Mode..."
    statusLabel.TextColor3 = Color3.fromRGB(255, 150, 50)
    
    if not isOptimized then
        optimizePerformance()
        wait(0.5)
    end
    
    -- Ultra lighting (Maximum performance)
    Lighting.GlobalShadows = false
    Lighting.Technology = Enum.Technology.Legacy -- Fastest rendering
    Lighting.FogEnd = 1000000 -- No fog at all
    Lighting.FogStart = 1000000
    Lighting.Brightness = 5 -- Very bright
    Lighting.Ambient = Color3.fromRGB(178, 178, 178)
    Lighting.OutdoorAmbient = Color3.fromRGB(178, 178, 178)
    Lighting.ColorShift_Bottom = Color3.fromRGB(255, 255, 255)
    Lighting.ColorShift_Top = Color3.fromRGB(255, 255, 255)
    
    -- Ultra rendering settings
    pcall(function()
        settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
        settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level01
        settings().Rendering.GraphicsMode = Enum.GraphicsMode.Direct3D9
        settings().Physics.AllowSleep = true
        settings().Physics.ThrottleAdjustTime = 0
    end)
    
    -- Ultra part optimization
    for _, obj in pairs(optimizedParts) do
        if obj and obj.Parent then
            -- Convert everything to basic plastic
            obj.Material = Enum.Material.Plastic
            obj.Reflectance = 0
            obj.CastShadow = false
            
            -- Remove all surface details
            if obj:FindFirstChild("SurfaceGui") then
                obj.SurfaceGui:Destroy()
            end
        end
    end
    
    -- Disable all effects and lighting
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("ParticleEmitter") or 
           obj:IsA("Fire") or 
           obj:IsA("Smoke") or 
           obj:IsA("Sparkles") or
           obj:IsA("PointLight") or 
           obj:IsA("SpotLight") or 
           obj:IsA("SurfaceLight") then
            obj.Enabled = false
        elseif obj:IsA("Atmosphere") then
            -- Completely remove atmospheric effects
            obj.Density = 0
            obj.Offset = 0
            obj.Glare = 0
            obj.Haze = 0
        elseif obj:IsA("Clouds") then
            obj.Enabled = false
            obj.Density = 0
        elseif obj:IsA("BloomEffect") or obj:IsA("BlurEffect") or obj:IsA("ColorCorrectionEffect") then
            obj.Enabled = false
        elseif obj:IsA("Sound") and obj.IsPlaying then
            obj.Volume = obj.Volume * 0.5
        end
    end
    
    -- Multiple garbage collections
    for i = 1, 3 do
        collectgarbage("collect")
        wait(0.1)
    end
    
    isUltraMode = true
    statusLabel.Text = "Ultra âœ“"
    statusLabel.TextColor3 = Color3.fromRGB(255, 100, 50)
    ultraBtn.Text = "âœ“ ULTRA"
    ultraBtn.BackgroundColor3 = Color3.fromRGB(255, 150, 50)
end

-- Enhanced reset function
local function resetSettings()
    statusLabel.Text = "Resetting..."
    statusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
    
    -- Restore all settings
    if originalSettings.StreamingEnabled ~= nil then
        Workspace.StreamingEnabled = originalSettings.StreamingEnabled
    end
    
    -- Restore lighting completely
    Lighting.GlobalShadows = originalSettings.GlobalShadows or true
    Lighting.FogEnd = originalSettings.FogEnd or 100000
    Lighting.FogStart = originalSettings.FogStart or 0
    Lighting.FogColor = originalSettings.FogColor or Color3.fromRGB(191, 166, 143)
    Lighting.Brightness = originalSettings.Brightness or 1
    Lighting.Technology = originalSettings.Technology or Enum.Technology.ShadowMap
    Lighting.Ambient = originalSettings.Ambient or Color3.fromRGB(70, 70, 70)
    Lighting.ColorShift_Bottom = originalSettings.ColorShift_Bottom or Color3.fromRGB(0, 0, 0)
    Lighting.ColorShift_Top = originalSettings.ColorShift_Top or Color3.fromRGB(0, 0, 0)
    Lighting.OutdoorAmbient = originalSettings.OutdoorAmbient or Color3.fromRGB(70, 70, 70)
    Lighting.ShadowSoftness = originalSettings.ShadowSoftness or 0.2
    Lighting.ClockTime = originalSettings.ClockTime or 14
    
    -- Restore rendering settings
    pcall(function()
        if originalSettings.QualityLevel then
            settings().Rendering.QualityLevel = originalSettings.QualityLevel
        end
        if originalSettings.MeshPartDetailLevel then
            settings().Rendering.MeshPartDetailLevel = originalSettings.MeshPartDetailLevel
        end
        if originalSettings.GraphicsMode then
            settings().Rendering.GraphicsMode = originalSettings.GraphicsMode
        end
    end)
    
    -- Re-enable all effects
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("ParticleEmitter") or 
           obj:IsA("Fire") or 
           obj:IsA("Smoke") or 
           obj:IsA("Sparkles") or
           obj:IsA("PointLight") or 
           obj:IsA("SpotLight") or 
           obj:IsA("SurfaceLight") then
            obj.Enabled = true
        end
    end
    
    collectgarbage("collect")
    
    -- Reset variables
    isOptimized = false
    isUltraMode = false
    optimizedParts = {}
    
    statusLabel.Text = "Reset âœ“"
    statusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
    optimizeBtn.Text = "âš¡ OPTIMIZE"
    optimizeBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 250)
    ultraBtn.Text = "ULTRA"
    ultraBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 50)
end

-- Minimize function
local function toggleMinimize()
    if isMinimized then
        -- Restore window
        mainFrame:TweenSize(UDim2.new(0, 300, 0, 200), "Out", "Quart", 0.3, true)
        contentFrame.Visible = true
        minimizeBtn.Text = "âˆ’"
        isMinimized = false
    else
        -- Minimize window
        contentFrame.Visible = false
        mainFrame:TweenSize(UDim2.new(0, 300, 0, 25), "Out", "Quart", 0.3, true)
        minimizeBtn.Text = "+"
        isMinimized = true
    end
end

-- Button connections
optimizeBtn.MouseButton1Click:Connect(optimizePerformance)
ultraBtn.MouseButton1Click:Connect(ultraOptimize)
resetBtn.MouseButton1Click:Connect(resetSettings)
minimizeBtn.MouseButton1Click:Connect(toggleMinimize)

closeBtn.MouseButton1Click:Connect(function()
    if fpsConnection then
        fpsConnection:Disconnect()
    end
    if isOptimized or isUltraMode then
        resetSettings()
        wait(0.5)
    end
    screenGui:Destroy()
end)

-- Enhanced hover effects
local function addHoverEffect(button, normalColor, hoverColor)
    button.MouseEnter:Connect(function()
        local tween = TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = hoverColor})
        tween:Play()
    end)
    button.MouseLeave:Connect(function()
        local tween = TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = normalColor})
        tween:Play()
    end)
end

addHoverEffect(optimizeBtn, Color3.fromRGB(50, 150, 250), Color3.fromRGB(70, 170, 255))
addHoverEffect(resetBtn, Color3.fromRGB(150, 50, 50), Color3.fromRGB(170, 70, 70))
addHoverEffect(ultraBtn, Color3.fromRGB(255, 100, 50), Color3.fromRGB(255, 120, 70))
addHoverEffect(closeBtn, Color3.fromRGB(255, 80, 80), Color3.fromRGB(255, 100, 100))
addHoverEffect(minimizeBtn, Color3.fromRGB(255, 200, 50), Color3.fromRGB(255, 220, 70))

-- Auto-optimization detector
spawn(function()
    wait(5)
    while screenGui.Parent do
        if fps < 20 and not isOptimized then
            statusLabel.Text = "Low FPS detected"
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
        wait(10)
    end
end)

print("NEBULA CLIENT Optimizer (BETA) loaded! (Fixed Version)")
print("Changes: Better FPS optimization, No fog, Bright sky, Enhanced rendering")